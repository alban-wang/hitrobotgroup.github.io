<html>
<head>
    <title>自动更新</title>

    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    <link rel="stylesheet" href="jquery/jquery.mobile-1.4.5.min.css">
    <script src="jquery/jquery-1.8.3.min.js"></script>
    <script>
        $(document).bind('mobileinit', function () {
            $.mobile.changePage.defaults.changeHash = false;
            $.mobile.hashListeningEnabled = false;
            $.mobile.pushStateEnabled = false;
        });
    </script>
    <script src="jquery/jquery.mobile-1.4.5.min.js"></script>


    <script src="js/eventemitter2.min.js"></script>
    <script src="js/roslib.min.js"></script>
    <script src="js/three.min.js"></script>


    <script>

        $(function () {

            var ros = new ROSLIB.Ros();

            var url = 'ws://' + localStorage.serverIP + ':9090';

            ros.connect(url);

           
            console.log(localStorage.serverIP);


            var ShellTopic = new ROSLIB.Topic({
                ros: ros,
                name: '/shell_string',
                messageType: 'std_msgs/String'
            });

            var ShellFeedback = new ROSLIB.Topic({
                ros: ros,
                name: '/shell_feedback',
                messageType: 'std_msgs/String'
            });


            var Msg = new ROSLIB.Message({
                data: '',
            });


            ShellFeedback.subscribe(ShellFeedbackCallBack);


            $("#btn-software-update").click(function () {
                $("#H1").text("updating...");
                Msg.data = '\
                                        rostopic pub -1 /shell_feedback std_msgs/String "Received from rosbridge_shell node."; \
            	                        cd ~; mkdir -p workspaces/hitrobot/; cd workspaces/hitrobot/; \
                                        if [ -d "release" ]; then \
                                            rostopic pub -1 /shell_feedback std_msgs/String "Trying to pull from workspaces ... This may take several minutes, please wait."; \
                                            cd release; git reset --hard HEAD^; git pull; _RC=$?; \
                                        else \
                                            rostopic pub -1 /shell_feedback std_msgs/String "Trying to clone from workspaces ... This may take several minutes, please wait."; \
                                            sudo rm -f /etc/resolv.conf; \
                                            sudo ln -s /run/resolvconf/resolv.conf /etc/resolv.conf; \
                                            _BRANCH=$ROS_DISTRO; \
                                            uname -m | grep arm; \
                                            if [ $? -eq 0 ]; then \
                                                _BRANCH=$_BRANCH"-arm"; \
                                            fi; \
                                            git clone -b $_BRANCH https://github.com/hitrobotgroup/release; _RC=$?; \
                                        fi; \
                                        if [ $_RC -eq 0 ]; then \
                                            rostopic pub -1 /shell_feedback std_msgs/String "Synchronized with $_BRANCH branch."; \
                                            if [ -d "/var/www" ]; then \
                                                rostopic pub -1 /shell_feedback std_msgs/String "Checking website server ..."; \
                                            else \
                                                rostopic pub -1 /shell_feedback std_msgs/String "Installing website server ..."; \
                                                sudo apt-get install -y apache2; \
                                                sudo rm -rf /var/www; \
                                                sudo ln -s ~/catkin_ws/www/ /var/www; \
                                            fi; \
                                        else \
                                            rostopic pub -1 /shell_feedback std_msgs/String "Failed to synchronized with $_BRANCH branch, please check the network connection."; \
                                        fi; \
                                        if [ $_RC -eq 0 ]; then \
                                            _FB="success"; \
                                        else \
                                            _FB="failure"; \
                                        fi; \
                                        rostopic pub -1 /shell_feedback std_msgs/String $_FB; \
                                        unset _FB; \
                                        if [ $_RC -eq 0 ]; then \
                                            rostopic pub -1 /shell_feedback std_msgs/String "Restarting websocket connection, please do not close and wait for reconnection."; \
                                            sudo reboot; \
                                        fi; \
                                        unset _BRANCH; unset _RC;';
                ShellTopic.publish(Msg);

            });


            ros.on('connection', function () {
                $("#H2").text("");
                $("#H2").css("color", "green");
                $("#H2").text($("#H2").text() + "Connected to websocket server.\n");
                $("#btn-software-update").prop('disabled', false).removeClass("ui-disabled");

            });

            ros.on("close", function () {
                $("#H2").css("color", "red");
                $("#H2").text($("#H2").text() + "Error connecting to websocket server.\n");
                $("#btn-software-update").prop('disabled', false).addClass("ui-disabled");
            });

        });
        



        function ShellFeedbackCallBack(data) {
            $("#H2").css("color", "black");

            if ("success" == data.data) {
                $("#H2").text($("#H2").text() + "updata success\n");
            }
            else if ("failure" == data.data) {
                $("#H2").text($("#H2").text() + "updata failure\n");
            }
            else {
                $("#H2").text($("#H2").text() + data.data+"\n");
            }

        }
    </script>
</head>
<body>
    <div data-role="page" id="hrg-main-page">

        <div data-role="content">
            <a href="#" data-transition="slide" data-role="button" data-icon="arrow-d" data-iconpos="right" data-theme="b" id="btn-software-update" aria-disabled="true" class="ui-disabled">更 新</a>
            <h3 id="H1" style="text-align: center"></h3>
            <h3 id="H2" style="text-align: center"></h3>
        </div>
    </div>
</body>
</html>
