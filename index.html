<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-dark.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>workspaces by hitrobotgroup</title>
    <script src="javascripts/eventemitter2.min.js"></script>
    <script src="javascripts/roslib.min.js"></script>
    <script src="javascripts/three.min.js"></script>
    <script>
        // setup connection to the ROS server and prepare the topic
        var ros = new ROSLIB.Ros();

        var shell_string = new ROSLIB.Topic({
            ros: ros,
            name: '/system_shell/shell_string',
            messageType: 'std_msgs/String'
        });

        var shell_feedback = new ROSLIB.Topic({
            ros: ros,
            name: '/system_shell/shell_feedback',
            messageType: 'std_msgs/String'
        });
    </script>
</head>

<body>
    <div id="container">
        <div class="inner">

            <header>
                <h1>workspaces</h1>
                <h2>hitrobot</h2>
            </header>

            <section id="downloads" class="clearfix">
                <a id="update" class="button"><span id="update_label">update online</span></a>
            </section>

            <hr>

            <section id="main_content">
              
            </section>

            <footer>
                This page was generated by <a href="https://pages.github.com">GitHub Pages</a>. Tactile theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.
            </footer>


        </div>
    </div>
    <script>
        var host_ip = window.location.hostname;
        if ('' == host_ip) {
            host_ip = '192.168.0.7';
        } else if ('hitrobotgroup.github.io' == host_ip) {
            host_ip = '192.168.43.7';
        }
        var websocket = 'ws://' + host_ip + ':9090';

        var is_first_connection = true;
        var shell_string_msg = new ROSLIB.Message({
            data: '',
        });

        document.getElementById("update").addEventListener('click', update);
        function update(event) {
            document.getElementById("update").removeEventListener('click', update);

            document.getElementById("update_label").innerHTML = 'updating...';
            document.getElementById("main_content").innerHTML = '<p>Connecting to ' + websocket + ' ...</p>';

            ros.connect(websocket);
        }

        function shell_feedback_cb(shell_feedback_msg) {
            if ("success" == shell_feedback_msg.data) {
                setTimeout(function () {
                    ros.connect(websocket);
                }, 60000);
            } else if ("failure" == shell_feedback_msg.data) {
                document.getElementById("update_label").innerHTML = 'report to us';
            } else {
                document.getElementById("main_content").innerHTML = '<p>' + shell_feedback_msg.data + '</p>' + document.getElementById("main_content").innerHTML;
            }
        }

        ros.on('connection', function () {
            document.getElementById("main_content").innerHTML = '<p>Connected to websocket server.</p>' + document.getElementById("main_content").innerHTML;
            shell_feedback.subscribe(shell_feedback_cb);

            if (is_first_connection) {
            	is_first_connection = false;
            	//shell_string_msg.data = '\
                //                        rostopic pub -1 /system_shell/shell_feedback std_msgs/String "Received from system_shell node."; \
                //(for pa3)
                //sudo chown root:root ./lib/stm32_driver/stm32_driver; \
                //                                sudo chmod u+s ./lib/stm32_driver/stm32_driver; \
                //map map_edit
                //ro/rw
                //                        rostopic pub -1 /system_shell/shell_feedback std_msgs/String "Received from system_shell node."; \
                //                        read;';
            	shell_string_msg.data = '\
                                        rostopic pub -1 /system_shell/shell_feedback std_msgs/String "Received from system_shell node."; \
            	                        cd ~; mkdir -p workspaces/hitrobot/; cd workspaces/hitrobot/; \
                                        if [ -d "release" ]; then \
                                            rostopic pub -1 /system_shell/shell_feedback std_msgs/String "Trying to pull from workspaces ... This may take several minutes, please wait."; \
                                            cd release; cp -f install/share/bringup/param/map* ~; git reset --hard HEAD^; git pull; _RC=$?; \
                                        else \
                                            rostopic pub -1 /system_shell/shell_feedback std_msgs/String "Trying to clone from workspaces ... This may take several minutes, please wait."; \
                                            sudo rm -f /etc/resolv.conf; \
                                            sudo ln -s /run/resolvconf/resolv.conf /etc/resolv.conf; \
                                            _BRANCH=$ROS_DISTRO; \
                                            uname -m | grep arm; \
                                            if [ $? -eq 0 ]; then \
                                                _BRANCH=$_BRANCH"-arm"; \
                                            fi; \
                                            git clone -b $_BRANCH https://github.com/hitrobotgroup/release; _RC=$?; \
                                        fi; \
                                        if [ $_RC -eq 0 ]; then \
                                            rostopic pub -1 /system_shell/shell_feedback std_msgs/String "Synchronized with $_BRANCH branch."; \
                                            if [ -d "/var/www" ]; then \
                                                rostopic pub -1 /system_shell/shell_feedback std_msgs/String "Checking website server ..."; \
                                            else \
                                                rostopic pub -1 /system_shell/shell_feedback std_msgs/String "Installing website server ..."; \
                                                sudo apt-get install -y apache2; \
                                                sudo rm -rf /var/www; \
                                                sudo ln -s ~/catkin_ws/www/ /var/www; \
                                            fi; \
                                            if [[ -n $_BRANCH ]]; then \
                                                rostopic pub -1 /system_shell/shell_feedback std_msgs/String "Linking to local workspaces ..."; \
                                                cd ~; cp -f catkin_ws/src/bringup/param/map* ~; rm -rf catkin_ws; ln -s workspaces/hitrobot/release/ catkin_ws; rm -f ~/Desktop/*; \
                                                cd ~/.config/autostart/; \
                                                if [ -f "gnome-terminal.desktop" ]; then \
                                                    rostopic pub -1 /system_shell/shell_feedback std_msgs/String "Resetting autostart config ..."; \
                                                    mv gnome-terminal.desktop ros_org.desktop; \
                                                    sed -i -e "s/Exec=.*/Exec=gnome-terminal -x bash -c \'\\\'\'~\\\/catkin_ws\\\/boot.sh\'\\\'\'/" ros_org.desktop; \
                                                    sed -i -e "s/Name\\\[en_US\\\]=.*/Name[en_US]=ros_org/" ros_org.desktop; \
                                                    sed -i -e "s/Name=.*/Name=ros_org/" ros_org.desktop; \
                                                fi; \
                                            fi; \
                                            if [[ `whoami` == hitrobot ]]; then \
                                                rostopic pub -1 /system_shell/shell_feedback std_msgs/String "Setting hitrobot hardware ..."; \
                                                cd ~/catkin_ws/devel/; \
                                                _TTYS=`dmesg | awk \'\\\'\'/ttyS/{print $4}\'\\\'\'`; \
                                                sudo sed -i "s/\\\/dev\\\/ttySx/\\\/dev\\\/$_TTYS/" ./share/bringup/launch/will2/will2-base.launch; \
                                                unset _TTYS; \
                                            fi; \
                                            mv -f ~/map* ~/catkin_ws/install/share/bringup/param; \
                                        else \
                                            rostopic pub -1 /system_shell/shell_feedback std_msgs/String "Failed to synchronized with $_BRANCH branch, please check the network connection."; \
                                            rm -f ~/map*; \
                                        fi; \
                                        if [ $_RC -eq 0 ]; then \
                                            _FB="success"; \
                                        else \
                                            _FB="failure"; \
                                        fi; \
                                        rostopic pub -1 /system_shell/shell_feedback std_msgs/String $_FB; \
                                        unset _FB; \
                                        if [ $_RC -eq 0 ]; then \
                                            rostopic pub -1 /system_shell/shell_feedback std_msgs/String "Restarting websocket connection, please do not close and wait for reconnection."; \
                                            if [[ -n $_BRANCH ]]; then \
                                                if [[ `whoami` == hitrobot ]]; then \
                                                    if [[ `hostname` != hitrobot-will2 ]]; then \
                                                        rostopic pub -1 /system_shell/shell_feedback std_msgs/String "Changing hostname to hitrobot-will2 ..."; \
                                                        sudo sed -i -e "/$(hostname)/ c hitrobot-will2" /etc/hostname; \
                                                        sudo sed -i "2s/$(hostname)/hitrobot-will2/" /etc/hosts; \
                                                    fi; \
                                                fi; \
                                            fi; \
                                            sudo reboot; \
                                        fi; \
                                        unset _BRANCH; unset _RC;';
                shell_string.publish(shell_string_msg);
            } else {
                shell_string_msg.data = 'rostopic pub -1 /system_shell/shell_feedback std_msgs/String "Updated to the newest version successfully.";';
                shell_string.publish(shell_string_msg);
                document.getElementById("update_label").innerHTML = 'bingo updated';
            }
        });

        ros.on('error', function (error) {
            document.getElementById("main_content").innerHTML = '<p>Error connecting to websocket server: ' + error + '</p>' + document.getElementById("main_content").innerHTML;
            document.getElementById("update_label").innerHTML = 'report to us';
        });

        ros.on('close', function () {
            document.getElementById("main_content").innerHTML = '<p>Connection to websocket server closed.</p>' + document.getElementById("main_content").innerHTML;
            shell_feedback.unsubscribe(shell_feedback_cb);
        });
    </script>
</body>
</html>
