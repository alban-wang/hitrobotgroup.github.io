<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-dark.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>workspaces by hitrobotgroup</title>
    <script src="javascripts/eventemitter2.min.js"></script>
    <script src="javascripts/roslib.min.js"></script>
    <script src="javascripts/three.min.js"></script>
    <script>
        // setup connection to the ROS server and prepare the topic
        var ros = new ROSLIB.Ros();

        var shell_string = new ROSLIB.Topic({
            ros: ros,
            name: '/system_shell/shell_string',
            messageType: 'std_msgs/String'
        });

        var shell_feedback = new ROSLIB.Topic({
            ros: ros,
            name: '/system_shell/shell_feedback',
            messageType: 'std_msgs/String'
        });
    </script>
</head>

<body>
    <div id="container">
        <div class="inner">

            <header>
                <h1>workspaces</h1>
                <h2>hitrobot</h2>
            </header>

            <section id="downloads" class="clearfix">
                <a id="update" class="button"><span id="update_label">update online</span></a>
            </section>

            <hr>

            <section id="main_content">
              
            </section>

            <footer>
                This page was generated by <a href="https://pages.github.com">GitHub Pages</a>. Tactile theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.
            </footer>


        </div>
    </div>
    <script>
        var host_ip = window.location.hostname;
        if ('' == host_ip) {
            host_ip = '192.168.0.7';
        } else if ('hitrobotgroup.github.io' == host_ip) {
            host_ip = '192.168.43.252';
        }
        var websocket = 'ws://' + host_ip + ':9090';

        var is_first_connection = true;
        var shell_string_msg = new ROSLIB.Message({
            data: '',
        });

        document.getElementById("update").addEventListener('click', update);
        function update(event) {
            document.getElementById("update").removeEventListener('click', update);

            document.getElementById("update_label").innerHTML = 'updating...';
            document.getElementById("main_content").innerHTML = '<p>Connecting to ' + websocket + ' ...</p>';

            ros.connect(websocket);
        }

        function shell_feedback_cb(shell_feedback_msg) {
            if ("success" == shell_feedback_msg.data) {
                shell_string_msg.data = 'rosnode kill -a; roslaunch bringup bringup.launch;';
                shell_string.publish(shell_string_msg);
                document.getElementById("update_label").innerHTML = 'bingo updated';
                setTimeout(function () {
                    ros.connect(websocket);
                }, 5000);
            } else if ("failure" == shell_feedback_msg.data) {
                document.getElementById("update_label").innerHTML = 'report to us';
            } else {
                document.getElementById("main_content").innerHTML = '<p>' + shell_feedback_msg.data + '</p>' + document.getElementById("main_content").innerHTML;
            }
        }

        ros.on('connection', function () {
            document.getElementById("main_content").innerHTML = '<p>Connected to websocket server.</p>' + document.getElementById("main_content").innerHTML;
            shell_feedback.subscribe(shell_feedback_cb);

            if (is_first_connection) {
            	is_first_connection = false;
            	shell_string_msg.data = '\
                                        rostopic pub -1 /system_shell/shell_feedback std_msgs/String "Received from system_shell node."; \
            	                        cd ~; mkdir -p workspaces/hitrobot/; cd workspaces/hitrobot/; \
                                        if [ -d "release" ]; then \
                                            rostopic pub -1 /system_shell/shell_feedback std_msgs/String "Trying to pull from workspaces ... This may take several minutes, please wait."; \
                                            cd release; git pull; _RC=$?; \
                                        else \
                                            cat /etc/issue | grep 14.04 \
                                            if [ $? -eq 0 ]; then \
                                                _BRANCH="indigo"; \
                                            fi; \
                                            cat /etc/issue | grep 15.04 \
                                            if [ $? -eq 0 ]; then \
                                                _BRANCH="jade"; \
                                            fi; \
                                            cat /etc/issue | grep 16.04 \
                                            if [ $? -eq 0 ]; then \
                                                _BRANCH="kinetic"; \
                                            fi; \
                                            uname -m | grep arm \
                                            if [ $? -eq 0 ]; then \
                                                _BRANCH=$_BRANCH"-arm"; \
                                            fi; \
                                            rostopic pub -1 /system_shell/shell_feedback std_msgs/String "Trying to clone from workspaces ... This may take several minutes, please wait."; \
                                            git clone -b $_BRANCH https://github.com/hitrobotgroup/release; _RC=$?; \
                                            unset _BRANCH; \
                                            if [ $_RC -eq 0 ]; then \
                                                rostopic pub -1 /system_shell/shell_feedback std_msgs/String "Linking to local workspaces ..."; \
                                                cd ~; rm -r catkin_ws; ln -s workspaces/hitrobot/release/ catkin_ws; \
                                                if [[ whoami -eq "hitrobot" ]]; then \
                                                    cd ~/catkin_ws/install/; \
                                                    sudo chown root:root ./lib/stm32_driver/stm32_driver; \
                                                    sudo chmod u+s ./lib/stm32_driver/stm32_driver; \
                                                    _TTYS=`dmesg | awk \'/ttyS/{print $4}\'`; \
                                                    sudo sed -i "s/\/dev\/ttySx/\/dev\/$_TTYS/" ./share/bringup/launch/will2/will2-base.launch; \
                                                    unset _TTYS; \
                                                    if [[ hostname -eq "will2" ]]; then \
                                                        ; \
                                                    else \
                                                        sudo sed -i "2s/$(hostname)/will2/" /etc/hosts; \
                                                        sudo sed -i -e "/$(hostname)/ c will2" /etc/hostname; \
                                                        sudo hostname -F /etc/hostname; \
                                                    fi; \
                                                fi; \
                                            fi; \
                                        fi; \
                                        if [ $_RC -eq 0 ]; then \
                                            rostopic pub -1 /system_shell/shell_feedback std_msgs/String "Synchronized with workspaces."; \
                                            rostopic pub -1 /system_shell/shell_feedback std_msgs/String "Restarting websocket connection."; \
                                        else \
                                            rostopic pub -1 /system_shell/shell_feedback std_msgs/String "Failed to synchronized with workspaces, please check the network connection."; \
                                        fi; \
                                        if [ $_RC -eq 0 ]; then \
                                            _FB="success"; \
                                        else \
                                            _FB="failure"; \
                                        fi; \
                                        rostopic pub -1 /system_shell/shell_feedback std_msgs/String $_FB; \
                                        unset _RC; unset _FB;';
                shell_string.publish(shell_string_msg);
            } else {
                shell_string_msg.data = 'rostopic pub -1 /system_shell/shell_feedback std_msgs/String "Updated to the newest version successfully.";';
                shell_string.publish(shell_string_msg);
            }
        });

        ros.on('error', function (error) {
            document.getElementById("main_content").innerHTML = '<p>Error connecting to websocket server: ' + error + '</p>' + document.getElementById("main_content").innerHTML;
            document.getElementById("update_label").innerHTML = 'report to us';
        });

        ros.on('close', function () {
            document.getElementById("main_content").innerHTML = '<p>Connection to websocket server closed.</p>' + document.getElementById("main_content").innerHTML;
            shell_feedback.unsubscribe(shell_feedback_cb);
        });
    </script>
</body>
</html>
